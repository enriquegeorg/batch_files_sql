--INSERE ODBCS QUE ESTAO NAS TABELAS DEFAULT E NAO ESTAO NAS TABELAS CONSULTADAS PELO SISTEMA
INSERT INTO TDFE_ODBC(COD_EMPRESA, COD_ODBC, DES_QUERY, QUERY) SELECT TFRW_EMPRESA.COD_EMPRESA, TDFE_ODBC_CARGA_DEFAULT.COD_ODBC, TDFE_ODBC_CARGA_DEFAULT.DES_QUERY, TDFE_ODBC_CARGA_DEFAULT.QUERY FROM TFRW_EMPRESA INNER JOIN TDFE_ODBC_CARGA_DEFAULT ON(TDFE_ODBC_CARGA_DEFAULT.COD_ERP=TFRW_EMPRESA.COD_ERP) LEFT JOIN TDFE_ODBC ON(TDFE_ODBC.COD_ODBC=TDFE_ODBC_CARGA_DEFAULT.COD_ODBC AND TDFE_ODBC.COD_EMPRESA=TFRW_EMPRESA.COD_EMPRESA) WHERE TDFE_ODBC.COD_ODBC IS NULL;
WHILE (SELECT COUNT(*) FROM TFRW_EMPRESA INNER JOIN TDFE_ODBC_CARGA_DEFAULT ON(TDFE_ODBC_CARGA_DEFAULT.COD_ERP=TFRW_EMPRESA.COD_ERP) LEFT JOIN TDFE_ODBC_ESTABELECIMENTO ON(TDFE_ODBC_ESTABELECIMENTO.COD_ODBC=TDFE_ODBC_CARGA_DEFAULT.COD_ODBC)WHERE TDFE_ODBC_ESTABELECIMENTO.COD_ODBC IS NULL) > 0
BEGIN
INSERT INTO TDFE_ODBC_ESTABELECIMENTO(ID, COD_EMPRESA, COD_ESTABELECIMENTO,COD_ODBC, ID_ODBC_CONNECTION_STRING) SELECT TOP 1 (SELECT MAX(ID)+1 FROM TDFE_ODBC_ESTABELECIMENTO),TFRW_EMPRESA.COD_EMPRESA,NULL,TDFE_ODBC_CARGA_DEFAULT.COD_ODBC,TDFE_ODBC_CARGA_DEFAULT.ID_ODBC_CONNECTION_STRING FROM TFRW_EMPRESA INNER JOIN TDFE_ODBC_CARGA_DEFAULT ON(TDFE_ODBC_CARGA_DEFAULT.COD_ERP=TFRW_EMPRESA.COD_ERP) LEFT JOIN TDFE_ODBC_ESTABELECIMENTO ON(TDFE_ODBC_ESTABELECIMENTO.COD_ODBC=TDFE_ODBC_CARGA_DEFAULT.COD_ODBC) WHERE TDFE_ODBC_ESTABELECIMENTO.COD_ODBC IS NULL;
END;
INSERT INTO TDFE_COLUNA_ODBC(COD_EMPRESA, COD_ODBC, COD_COLUNA, DES_NOME, DES_DESCRICAO, DES_CHAVE, DADOS_ODBC_EXTERNO, COD_ODBC_EXTERNO, COD_COLUNA_EXTERNA, COLUNA_VISIVEL, COLUNA_COMPUTADA) SELECT TFRW_EMPRESA.COD_EMPRESA,TDFE_ODBC_CARGA_DEFAULT.COD_ODBC,TDFE_ODBC_CARGA_COLUNA_DEFAULT.COD_COLUNA,TDFE_ODBC_CARGA_COLUNA_DEFAULT.DES_NOME,TDFE_ODBC_CARGA_COLUNA_DEFAULT.DES_DESCRICAO,TDFE_ODBC_CARGA_COLUNA_DEFAULT.DES_CHAVE,TDFE_ODBC_CARGA_COLUNA_DEFAULT.DADOS_ODBC_EXTERNO,TDFE_ODBC_CARGA_COLUNA_DEFAULT.COD_ODBC_EXTERNO,TDFE_ODBC_CARGA_COLUNA_DEFAULT.COD_COLUNA_EXTERNA,TDFE_ODBC_CARGA_COLUNA_DEFAULT.COLUNA_VISIVEL,TDFE_ODBC_CARGA_COLUNA_DEFAULT.COLUNA_COMPUTADA FROM TFRW_EMPRESA INNER JOIN TDFE_ODBC_CARGA_DEFAULT ON(TDFE_ODBC_CARGA_DEFAULT.COD_ERP=TFRW_EMPRESA.COD_ERP) INNER JOIN TDFE_ODBC_CARGA_COLUNA_DEFAULT ON(TDFE_ODBC_CARGA_COLUNA_DEFAULT.COD_ODBC=TDFE_ODBC_CARGA_DEFAULT.COD_ODBC AND TDFE_ODBC_CARGA_COLUNA_DEFAULT.COD_ERP=TDFE_ODBC_CARGA_DEFAULT.COD_ERP) LEFT JOIN TDFE_COLUNA_ODBC ON(TDFE_COLUNA_ODBC.COD_ODBC=TDFE_ODBC_CARGA_DEFAULT.COD_ODBC AND TDFE_COLUNA_ODBC.COD_EMPRESA=TFRW_EMPRESA.COD_EMPRESA) WHERE TDFE_COLUNA_ODBC.COD_ODBC IS NULL;

